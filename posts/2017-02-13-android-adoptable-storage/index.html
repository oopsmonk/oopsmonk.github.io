<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Android Adoptable Storage | oopsmonk</title><meta name=keywords content="Android"><meta name=description content="A study of adoptable storage in Android Marshmallow and Nougat.
How to Setup a Private Disk (External USB Storage) Android adoptable storage allow APP install to external storage that can reserve more internal space for other APPs.
Create Adoptable Storage Using Settings GUI Settings -> Storage & USB -> Portable storage -> Settings -> Format as internal
Use sm (Storage Manager) Command Find disk id # sm list-disks disk:8,16 disk:8,0 Format as internal # sm partition disk:8,0 private # sm list-volumes all public:8,17 mounted 629C-FBAF emulated:8,2 unmounted null private mounted null emulated mounted null private:8,2 mounted 3f538e6e-e6a9-4163-ac1e-e4c6602b3c34 Now, it&rsquo;s a private storage in system."><meta name=author content="oopsmonk"><link rel=canonical href=https://oopsmonk.github.io/posts/2017-02-13-android-adoptable-storage/><link crossorigin=anonymous href=/assets/css/stylesheet.6a98292fb8fa8cf0f3ba4042d4b75515c04267550f3ad49ff6271b5af9562443.css integrity="sha256-apgpL7j6jPDzukBC1LdVFcBCZ1UPOtSf9icbWvlWJEM=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://oopsmonk.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://oopsmonk.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://oopsmonk.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://oopsmonk.github.io/apple-touch-icon.png><link rel=mask-icon href=https://oopsmonk.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Android Adoptable Storage"><meta property="og:description" content="A study of adoptable storage in Android Marshmallow and Nougat.
How to Setup a Private Disk (External USB Storage) Android adoptable storage allow APP install to external storage that can reserve more internal space for other APPs.
Create Adoptable Storage Using Settings GUI Settings -> Storage & USB -> Portable storage -> Settings -> Format as internal
Use sm (Storage Manager) Command Find disk id # sm list-disks disk:8,16 disk:8,0 Format as internal # sm partition disk:8,0 private # sm list-volumes all public:8,17 mounted 629C-FBAF emulated:8,2 unmounted null private mounted null emulated mounted null private:8,2 mounted 3f538e6e-e6a9-4163-ac1e-e4c6602b3c34 Now, it&rsquo;s a private storage in system."><meta property="og:type" content="article"><meta property="og:url" content="https://oopsmonk.github.io/posts/2017-02-13-android-adoptable-storage/"><meta property="og:image" content="https://oopsmonk.github.io/images/bio-oopsmonk.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-02-13T10:08:28+08:00"><meta property="article:modified_time" content="2017-02-13T10:08:28+08:00"><meta property="og:site_name" content="Viva La Vida"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://oopsmonk.github.io/images/bio-oopsmonk.jpg"><meta name=twitter:title content="Android Adoptable Storage"><meta name=twitter:description content="A study of adoptable storage in Android Marshmallow and Nougat.
How to Setup a Private Disk (External USB Storage) Android adoptable storage allow APP install to external storage that can reserve more internal space for other APPs.
Create Adoptable Storage Using Settings GUI Settings -> Storage & USB -> Portable storage -> Settings -> Format as internal
Use sm (Storage Manager) Command Find disk id # sm list-disks disk:8,16 disk:8,0 Format as internal # sm partition disk:8,0 private # sm list-volumes all public:8,17 mounted 629C-FBAF emulated:8,2 unmounted null private mounted null emulated mounted null private:8,2 mounted 3f538e6e-e6a9-4163-ac1e-e4c6602b3c34 Now, it&rsquo;s a private storage in system."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://oopsmonk.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Android Adoptable Storage","item":"https://oopsmonk.github.io/posts/2017-02-13-android-adoptable-storage/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Android Adoptable Storage","name":"Android Adoptable Storage","description":"A study of adoptable storage in Android Marshmallow and Nougat.\nHow to Setup a Private Disk (External USB Storage) Android adoptable storage allow APP install to external storage that can reserve more internal space for other APPs.\nCreate Adoptable Storage Using Settings GUI Settings -\u0026gt; Storage \u0026amp; USB -\u0026gt; Portable storage -\u0026gt; Settings -\u0026gt; Format as internal\nUse sm (Storage Manager) Command Find disk id # sm list-disks disk:8,16 disk:8,0 Format as internal # sm partition disk:8,0 private # sm list-volumes all public:8,17 mounted 629C-FBAF emulated:8,2 unmounted null private mounted null emulated mounted null private:8,2 mounted 3f538e6e-e6a9-4163-ac1e-e4c6602b3c34 Now, it\u0026rsquo;s a private storage in system.","keywords":["Android"],"articleBody":"A study of adoptable storage in Android Marshmallow and Nougat.\nHow to Setup a Private Disk (External USB Storage) Android adoptable storage allow APP install to external storage that can reserve more internal space for other APPs.\nCreate Adoptable Storage Using Settings GUI Settings -\u003e Storage \u0026 USB -\u003e Portable storage -\u003e Settings -\u003e Format as internal\nUse sm (Storage Manager) Command Find disk id # sm list-disks disk:8,16 disk:8,0 Format as internal # sm partition disk:8,0 private # sm list-volumes all public:8,17 mounted 629C-FBAF emulated:8,2 unmounted null private mounted null emulated mounted null private:8,2 mounted 3f538e6e-e6a9-4163-ac1e-e4c6602b3c34 Now, it’s a private storage in system.\n# mount /dev/block/mmcblk0p1 /system ext4 ro,seclabel,noatime,data=ordered 0 0 /dev/block/mmcblk0p3 /cache ext4 rw,seclabel,nosuid,nodev,noatime,discard,journal_checksum,errors=continue,data=ordered 0 0 /dev/block/mmcblk0p2 /data ext4 rw,seclabel,nosuid,nodev,noatime,discard,journal_checksum,errors=continue,data=ordered 0 0 /dev/block/dm-0 /mnt/expand/3f538e6e-e6a9-4163-ac1e-e4c6602b3c34 ext4 rw,dirsync,seclabel,nosuid,nodev,noatime 0 0 Moving APP to External(Adoptable) Storage Not all APPs can move to external storage, only the APPs are declared android:installLocation attribute in the Androidmanifest.xml.\nThe value for installLocation are auto, internalOnly, and preferExternal.\nInstall APP to External pm commands can use to select or find APP’s install location.\npm path PACKAGE\nGet the location path of the APP. pm get-install-location\nGet the global default install location which is stored in Settings database(default_install_location). pm set-install-location [0|1|2]\nSet default install location 0:auto, 1:internal, 2:external. pm install -f PATH\nInstall on internal storage. pm install -s PATH\nInstall on external storage. pm::makeInstallParams\nHow to Move APPs to External Moving around External and Internal storage:\nSettings Settings -\u003e APPs -\u003e package -\u003e Storage -\u003e Storage Used.\npm (Package Manager) Move APP between internal, and external storage.\npm move-package PACKAGE [internal|UUID]\nEx:\n# pm install /data/app-debug.apk # pm path com.oopsmonk.testinternalinstall package:/data/app/com.oopsmonk.testinternalinstall-1/base.apk # sm list-volumes emulated:8,2 unmounted null private mounted null emulated mounted null private:8,2 mounted 9c019bf2-bb58-4c81-9afe-8ed22d752f91 # pm move-package com.oopsmonk.testinternalinstall 9c019bf2-bb58-4c81-9afe-8ed22d752f91 # pm path com.oopsmonk.testinternalinstall package:/mnt/expand/9c019bf2-bb58-4c81-9afe-8ed22d752f91/app/com.oopsmonk.testinternalinstall-1/base.apk Gaming Rules Adoptable storage will create a new partition table and destroy data on the disk. System APP should not install on external storage. APPs data may lost if external storage was broken. You can create different external storage using separate disks. You should carefully consider whether to install APPs on external storage.\nHow Adoptable Storage Work? Vold(Volume Daemon) is in charge of creating and mounting storage include adoptable storage. It will create two partitions (android_meta and android_expand) for adoptable storage, the android_meta is a reserved space for feature use and android_expand is the external storage which is encrypted via dm-crypt.\nBoth partitions have specific type code.\nandroid_meta: 19A710A2-B3CA-11E4-B026-10604B889DCF android_expand: 193D1EA4-B3CA-11E4-B075-10604B889DCF The encrypt key is located in /data/misc/vold/expand_GUID.key.\nDeclare Adoptable Devices Vold parses mount flags from fstab.{ro.hardware}. As an adoptable device, the flags of voldmanaged and encryptable should be defined. In the meantime, vold.has_adoptable is set to 1.\nfstab.fugu\n/devices/*/dwc3-host.2/usb*\tauto\tauto\tdefaults\tvoldmanaged=usb:auto,encryptable=userdata vold/main\n/* Loop through entries looking for ones that vold manages */ bool has_adoptable = false; for (int i = 0; i \u003c fstab-\u003enum_entries; i++) { if (fs_mgr_is_voldmanaged(\u0026fstab-\u003erecs[i])) { if (fs_mgr_is_nonremovable(\u0026fstab-\u003erecs[i])) { LOG(WARNING) \u003c\u003c \"nonremovable no longer supported; ignoring volume\"; continue; } std::string sysPattern(fstab-\u003erecs[i].blk_device); std::string nickname(fstab-\u003erecs[i].label); int flags = 0; if (fs_mgr_is_encryptable(\u0026fstab-\u003erecs[i])) { flags |= android::vold::Disk::Flags::kAdoptable; has_adoptable = true; } if (fs_mgr_is_noemulatedsd(\u0026fstab-\u003erecs[i]) || property_get_bool(\"vold.debug.default_primary\", false)) { flags |= android::vold::Disk::Flags::kDefaultPrimary; } vm-\u003eaddDiskSource(std::shared_ptr\u003cVolumeManager::DiskSource\u003e( new VolumeManager::DiskSource(sysPattern, nickname, flags))); } } property_set(\"vold.has_adoptable\", has_adoptable ? \"1\" : \"0\"); return 0; fstab is parsed in fs_mgr_fstab.c\nstatic struct flag_list mount_flags[] = { { \"noatime\", MS_NOATIME }, { \"noexec\", MS_NOEXEC }, { \"nosuid\", MS_NOSUID }, { \"nodev\", MS_NODEV }, { \"nodiratime\", MS_NODIRATIME }, { \"ro\", MS_RDONLY }, { \"rw\", 0 }, { \"remount\", MS_REMOUNT }, { \"bind\", MS_BIND }, { \"rec\", MS_REC }, { \"unbindable\", MS_UNBINDABLE }, { \"private\", MS_PRIVATE }, { \"slave\", MS_SLAVE }, { \"shared\", MS_SHARED }, { \"defaults\", 0 }, { 0, 0 }, }; static struct flag_list fs_mgr_flags[] = { { \"wait\", MF_WAIT }, { \"check\", MF_CHECK }, { \"encryptable=\",MF_CRYPT }, { \"forceencrypt=\",MF_FORCECRYPT }, { \"fileencryption=\",MF_FILEENCRYPTION }, { \"forcefdeorfbe=\",MF_FORCEFDEORFBE }, { \"nonremovable\",MF_NONREMOVABLE }, { \"voldmanaged=\",MF_VOLDMANAGED}, { \"length=\", MF_LENGTH }, { \"recoveryonly\",MF_RECOVERYONLY }, { \"swapprio=\", MF_SWAPPRIO }, { \"zramsize=\", MF_ZRAMSIZE }, { \"verify\", MF_VERIFY }, { \"noemulatedsd\", MF_NOEMULATEDSD }, { \"notrim\", MF_NOTRIM }, { \"formattable\", MF_FORMATTABLE }, { \"slotselect\", MF_SLOTSELECT }, { \"nofail\", MF_NOFAIL }, { \"latemount\", MF_LATEMOUNT }, { \"defaults\", 0 }, { 0, 0 }, }; Creating Private Partition Tracing the code flow via sm partition DISK private command.\nframeworks/base/cmds/sm/src/com/android/commands/sm/Sm.java\npublic void runPartition() throws RemoteException { final String diskId = nextArg(); final String type = nextArg(); if (\"public\".equals(type)) { mSm.partitionPublic(diskId); } else if (\"private\".equals(type)) { mSm.partitionPrivate(diskId); } else if (\"mixed\".equals(type)) { final int ratio = Integer.parseInt(nextArg()); mSm.partitionMixed(diskId, ratio); } else { throw new IllegalArgumentException(\"Unsupported partition type \" + type); } } then VoldConnector issues partition command to Vold.\nMountService::partitionPrivate\nmConnector.execute(\"volume\", \"partition\", diskId, \"private\"); CommandListener::VolumeCmd::runCommand\nreturn sendGenericOkFail(cli, disk-\u003epartitionPrivate()); Vold handles the partition request.\nDisk::partitionMixed\n# Force unmount all volumes destroyAllVolumes(); # Destory the GPT data structures and then exit. # /system/bin/sgdisk # --zap-all # /dev/block/vold/disk:8,0 // Zap sometimes returns an error when it actually succeeded, so // just log as warning and keep rolling forward. if ((res = ForkExecvp(cmd)) != 0) { LOG(WARNING) \u003c\u003c \"Failed to zap; status \" \u003c\u003c res; } # Create encrypt key and parition GUID for android_expand. if (ReadRandomBytes(16, partGuidRaw) || ReadRandomBytes(16, keyRaw)) { LOG(ERROR) \u003c\u003c \"Failed to generate GUID or key\"; return -EIO; } # Write key to /data/misc/vold/expand_GUID.key if (!WriteStringToFile(keyRaw, BuildKeyPath(partGuid))) { LOG(ERROR) \u003c\u003c \"Failed to persist key\"; return -EIO; } else { LOG(DEBUG) \u003c\u003c \"Persisted key for GUID \" \u003c\u003c partGuid; } # Run partition command via sgdisk tool # /system/bin/sgdisk # --new=0:0:+16M # --typecode=0:19A710A2-B3CA-11E4-B026-10604B889DCF # --change-name=0:android_meta # --new=0:0:-0 # --typecode=0:193D1EA4-B3CA-11E4-B075-10604B889DCF # --partition-guid=0:c245733cd8ed24d20047ba0c3213de60 # --change-name=0:android_expand # /dev/block/vold/disk:8,0 if ((res = ForkExecvp(cmd)) != 0) { LOG(ERROR) \u003c\u003c \"Failed to partition; status \" \u003c\u003c res; return res; } Mounting Private Partition After disk’s partition is changed, kernel rescans the disk and emits an uevent to notify Vold.\nVolumeManager::handleBlockEvent\ncase NetlinkEvent::Action::kAdd: { ... auto disk = new android::vold::Disk(eventPath, device, source-\u003egetNickname(), flags); disk-\u003ecreate(); mDisks.push_back(std::shared_ptr\u003candroid::vold::Disk\u003e(disk)); break; } } break; } Disk::create\nnotifyEvent(ResponseCode::DiskCreated, StringPrintf(\"%d\", mFlags)); # Read lable, size, and system path readMetadata(); # parsing partition table readPartitions(); Disk::readPartitions\n# Force unmount all volumes destroyAllVolumes(); # Parsing partition table # /system/bin/sgdisk # --android-dump # /dev/block/vold/disk:8,0 status_t res = ForkExecvp(cmd, output); # Encrypted storage is used GPT partition table only. # Starting to create private volume } else if (table == Table::kGpt) { const char* typeGuid = strtok(nullptr, kSgdiskToken); const char* partGuid = strtok(nullptr, kSgdiskToken); if (!strcasecmp(typeGuid, kGptBasicData)) { createPublicVolume(partDevice); } else if (!strcasecmp(typeGuid, kGptAndroidExpand)) { createPrivateVolume(partDevice, partGuid); } } ... # Notify MountService notifyEvent(ResponseCode::DiskScanned); Creating private volume Disk::createPrivateVolume\n# Verify GUID and encrypt key if (NormalizeHex(partGuid, normalizedGuid)) { LOG(WARNING) \u003c\u003c \"Invalid GUID \" \u003c\u003c partGuid; return; } std::string keyRaw; if (!ReadFileToString(BuildKeyPath(normalizedGuid), \u0026keyRaw)) { PLOG(ERROR) \u003c\u003c \"Failed to load key for GUID \" \u003c\u003c normalizedGuid; return; } # Create private volume and format then destroy it. auto vol = std::shared_ptr\u003cVolumeBase\u003e(new PrivateVolume(device, keyRaw)); if (mJustPartitioned) { LOG(DEBUG) \u003c\u003c \"Device just partitioned; silently formatting\"; vol-\u003esetSilent(true); vol-\u003ecreate(); vol-\u003eformat(\"auto\"); vol-\u003edestroy(); vol-\u003esetSilent(false); } # volume create again mVolumes.push_back(vol); vol-\u003esetDiskId(getId()); vol-\u003esetPartGuid(partGuid); vol-\u003ecreate(); VolumeBase::create\n# PrivateVolume::doCreate status_t res = doCreate(); # Notify MountService to mount volume use onVolumeCreatedLocked() notifyEvent(ResponseCode::VolumeCreated, StringPrintf(\"%d \\\"%s\\\" \\\"%s\\\"\", mType, mDiskId.c_str(), mPartGuid.c_str())); PrivateVolume::doCreate\nif (CreateDeviceNode(mRawDevPath, mRawDevice)) { return -EIO; } // Recover from stale vold by tearing down any old mappings cryptfs_revert_ext_volume(getId().c_str()); // TODO: figure out better SELinux labels for private volumes unsigned char* key = (unsigned char*) mKeyRaw.data(); char crypto_blkdev[MAXPATHLEN]; int res = cryptfs_setup_ext_volume(getId().c_str(), mRawDevPath.c_str(), key, mKeyRaw.size(), crypto_blkdev); mDmDevPath = crypto_blkdev; if (res != 0) { PLOG(ERROR) \u003c\u003c getId() \u003c\u003c \" failed to setup cryptfs\"; return -EIO; } return OK; When MountService receives VOLUME_CREATED event from VolumeBase::create(), it calls Vold to do mount process.\nMountService::onEventLocked\n# Handle event from VolumeBase::create then get disk info. case VoldResponseCode.VOLUME_CREATED: { final String id = cooked[1]; final int type = Integer.parseInt(cooked[2]); final String diskId = TextUtils.nullIfEmpty(cooked[3]); final String partGuid = TextUtils.nullIfEmpty(cooked[4]); final DiskInfo disk = mDisks.get(diskId); final VolumeInfo vol = new VolumeInfo(id, type, disk, partGuid); mVolumes.put(id, vol); # Ack Vold to mount this volume. onVolumeCreatedLocked(vol); break; } MountService::handleMessage\n# Ack Vold to run mount command via vold/CommandListener. case H_VOLUME_MOUNT: { final VolumeInfo vol = (VolumeInfo) msg.obj; if (isMountDisallowed(vol)) { Slog.i(TAG, \"Ignoring mount \" + vol.getId() + \" due to policy\"); break; } try { mConnector.execute(\"volume\", \"mount\", vol.id, vol.mountFlags, vol.mountUserId); } catch (NativeDaemonConnectorException ignored) { } break; } CommandListener::VolumeCmd::runCommand\n} else if (cmd == \"mount\" \u0026\u0026 argc \u003e 2) { // mount [volId] [flags] [user] std::string id(argv[2]); auto vol = vm-\u003efindVolume(id); if (vol == nullptr) { return cli-\u003esendMsg(ResponseCode::CommandSyntaxError, \"Unknown volume\", false); } int mountFlags = (argc \u003e 3) ? atoi(argv[3]) : 0; userid_t mountUserId = (argc \u003e 4) ? atoi(argv[4]) : -1; vol-\u003esetMountFlags(mountFlags); vol-\u003esetMountUserId(mountUserId); # Call VolumeBase::mount() then PrivateVolume::doMount() int res = vol-\u003emount(); if (mountFlags \u0026 android::vold::VolumeBase::MountFlags::kPrimary) { vm-\u003esetPrimary(vol); } return sendGenericOkFail(cli, res); } else if (cmd == \"unmount\" \u0026\u0026 argc \u003e 2) { Conclusion The prosess of adoptable storage is more simple than Full Disk Encryption\nUnmount all volumes. Create new GPT table, GUID, and encrypt key. Generate android_meta, android_expand, and shared (if ratio partition) partitions. Get block device added uevent from Kernel. Decrypt private volumes. Mount public and private volumes. Related Source code # Communicate with Vold and Framework. frameworks/base/services/core/java/com/android/server/MountService.java # Parse fstab. system/core/fs_mgr # Partition, mount, unmout, and format private volume # Genrate encrypt key. system/vold/ # Decrytp and encrypt private volume, crypto type name is \"aes-cbc-essiv:sha256\" system/vold/cryptfs.c # Partition tool external/gptfdisk/sgdisk.cc ","wordCount":"1553","inLanguage":"en","datePublished":"2017-02-13T10:08:28+08:00","dateModified":"2017-02-13T10:08:28+08:00","author":{"@type":"Person","name":"oopsmonk"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://oopsmonk.github.io/posts/2017-02-13-android-adoptable-storage/"},"publisher":{"@type":"Organization","name":"oopsmonk","logo":{"@type":"ImageObject","url":"https://oopsmonk.github.io/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://oopsmonk.github.io/ accesskey=h title="Home (Alt + H)">Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://oopsmonk.github.io/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://oopsmonk.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://oopsmonk.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://oopsmonk.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://oopsmonk.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://oopsmonk.github.io/posts/>Posts</a></div><h1 class=post-title>Android Adoptable Storage</h1><div class=post-meta><span title='2017-02-13 10:08:28 +0800 +0800'>February 13, 2017</span>&nbsp;·&nbsp;8 min&nbsp;·&nbsp;oopsmonk&nbsp;|&nbsp;<a href=https://github.com/oopsmonk/oopsmonk.github.io/issues rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><p>A study of adoptable storage in Android Marshmallow and Nougat.</p><h1 id=how-to-setup-a-private-disk-external-usb-storage>How to Setup a Private Disk (External USB Storage)<a hidden class=anchor aria-hidden=true href=#how-to-setup-a-private-disk-external-usb-storage>#</a></h1><p>Android adoptable storage allow APP install to external storage that can reserve more internal space for other APPs.</p><h3 id=create-adoptable-storage-using-settings-gui>Create Adoptable Storage Using Settings GUI<a hidden class=anchor aria-hidden=true href=#create-adoptable-storage-using-settings-gui>#</a></h3><p>Settings -> Storage & USB -> Portable storage -> Settings -> Format as internal</p><h3 id=use-sm-storage-manager-command>Use sm (Storage Manager) Command<a hidden class=anchor aria-hidden=true href=#use-sm-storage-manager-command>#</a></h3><ul><li>Find disk id</li></ul><pre tabindex=0><code># sm list-disks  
disk:8,16  
disk:8,0  
</code></pre><ul><li>Format as internal</li></ul><pre tabindex=0><code># sm partition disk:8,0 private
# sm list-volumes all
public:8,17 mounted 629C-FBAF
emulated:8,2 unmounted null
private mounted null
emulated mounted null
private:8,2 mounted 3f538e6e-e6a9-4163-ac1e-e4c6602b3c34
</code></pre><p>Now, it&rsquo;s a private storage in system.</p><pre tabindex=0><code># mount
/dev/block/mmcblk0p1 /system ext4 ro,seclabel,noatime,data=ordered 0 0
/dev/block/mmcblk0p3 /cache ext4 rw,seclabel,nosuid,nodev,noatime,discard,journal_checksum,errors=continue,data=ordered 0 0
/dev/block/mmcblk0p2 /data ext4 rw,seclabel,nosuid,nodev,noatime,discard,journal_checksum,errors=continue,data=ordered 0 0
/dev/block/dm-0 /mnt/expand/3f538e6e-e6a9-4163-ac1e-e4c6602b3c34 ext4 rw,dirsync,seclabel,nosuid,nodev,noatime 0 0
</code></pre><h2 id=moving-app-to-externaladoptable-storage>Moving APP to External(Adoptable) Storage<a hidden class=anchor aria-hidden=true href=#moving-app-to-externaladoptable-storage>#</a></h2><p>Not all APPs can move to external storage, only the APPs are declared <strong>android:installLocation</strong> attribute in the Androidmanifest.xml.<br>The value for installLocation are <strong>auto</strong>, <strong>internalOnly</strong>, and <strong>preferExternal</strong>.</p><pre tabindex=0><code>&lt;manifest xmlns:android=&#34;http://schemas.android.com/apk/res/android&#34;
    android:installLocation=&#34;preferExternal&#34;
        ... &gt;
</code></pre><h2 id=install-app-to-external>Install APP to External<a hidden class=anchor aria-hidden=true href=#install-app-to-external>#</a></h2><p><code>pm</code> commands can use to select or find APP&rsquo;s install location.</p><ul><li><strong>pm path PACKAGE</strong><br>Get the location path of the APP.</li><li><strong>pm get-install-location</strong><br>Get the global default install location which is stored in Settings database(default_install_location).</li><li><strong>pm set-install-location [0|1|2]</strong><br>Set default install location 0:auto, 1:internal, 2:external.</li><li><strong>pm install -f PATH</strong><br>Install on internal storage.</li><li><strong>pm install -s PATH</strong><br>Install on external storage.</li></ul><p><a href=http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/pm/src/com/android/commands/pm/Pm.java#makeInstallParams>pm::makeInstallParams</a></p><h2 id=how-to-move-apps-to-external>How to Move APPs to External<a hidden class=anchor aria-hidden=true href=#how-to-move-apps-to-external>#</a></h2><p>Moving around External and Internal storage:</p><ul><li><p>Settings<br>Settings -> APPs -> package -> Storage -> Storage Used.</p></li><li><p>pm (Package Manager)<br>Move APP between internal, and external storage.<br><code>pm move-package PACKAGE [internal|UUID]</code></p></li></ul><p>Ex:</p><pre tabindex=0><code># pm install /data/app-debug.apk
# pm path com.oopsmonk.testinternalinstall                       
package:/data/app/com.oopsmonk.testinternalinstall-1/base.apk 

# sm list-volumes
emulated:8,2 unmounted null
private mounted null
emulated mounted null
private:8,2 mounted 9c019bf2-bb58-4c81-9afe-8ed22d752f91

# pm move-package com.oopsmonk.testinternalinstall 9c019bf2-bb58-4c81-9afe-8ed22d752f91 
# pm path com.oopsmonk.testinternalinstall                     
package:/mnt/expand/9c019bf2-bb58-4c81-9afe-8ed22d752f91/app/com.oopsmonk.testinternalinstall-1/base.apk
</code></pre><h1 id=gaming-rules>Gaming Rules<a hidden class=anchor aria-hidden=true href=#gaming-rules>#</a></h1><ol><li>Adoptable storage will create a new partition table and destroy data on the disk.</li><li>System APP should not install on external storage.</li><li>APPs data may lost if external storage was broken.</li><li>You can create different external storage using separate disks.</li></ol><p>You should carefully consider whether to install APPs on external storage.</p><h1 id=how-adoptable-storage-work>How Adoptable Storage Work?<a hidden class=anchor aria-hidden=true href=#how-adoptable-storage-work>#</a></h1><p><strong>Vold</strong>(Volume Daemon) is in charge of creating and mounting storage include adoptable storage. It will create two partitions (android_meta and android_expand) for adoptable storage, the android_meta is a reserved space for feature use and android_expand is the external storage which is encrypted via dm-crypt.<br>Both partitions have specific type code.</p><pre><code>android_meta: 19A710A2-B3CA-11E4-B026-10604B889DCF  
android_expand: 193D1EA4-B3CA-11E4-B075-10604B889DCF  
</code></pre><p>The encrypt key is located in /data/misc/vold/expand_GUID.key.</p><h2 id=declare-adoptable-devices>Declare Adoptable Devices<a hidden class=anchor aria-hidden=true href=#declare-adoptable-devices>#</a></h2><p>Vold parses mount flags from <code>fstab.{ro.hardware}</code>. As an adoptable device, the flags of <strong>voldmanaged</strong> and <strong>encryptable</strong> should be defined. In the meantime, <strong>vold.has_adoptable</strong> is set to 1.</p><p><a href=http://androidxref.com/7.1.1_r6/xref/device/asus/fugu/fstab.fugu>fstab.fugu</a></p><pre tabindex=0><code>/devices/*/dwc3-host.2/usb*	auto	auto	defaults	voldmanaged=usb:auto,encryptable=userdata
</code></pre><p><a href=http://androidxref.com/7.1.1_r6/xref/system/vold/main.cpp#process_config>vold/main</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>    <span style=color:#75715e>/* Loop through entries looking for ones that vold manages */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>bool</span> has_adoptable <span style=color:#f92672>=</span> false;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> fstab<span style=color:#f92672>-&gt;</span>num_entries; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>fs_mgr_is_voldmanaged</span>(<span style=color:#f92672>&amp;</span>fstab<span style=color:#f92672>-&gt;</span>recs[i])) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>fs_mgr_is_nonremovable</span>(<span style=color:#f92672>&amp;</span>fstab<span style=color:#f92672>-&gt;</span>recs[i])) {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>LOG</span>(WARNING) <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;nonremovable no longer supported; ignoring volume&#34;</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            std<span style=color:#f92672>::</span>string <span style=color:#a6e22e>sysPattern</span>(fstab<span style=color:#f92672>-&gt;</span>recs[i].blk_device);
</span></span><span style=display:flex><span>            std<span style=color:#f92672>::</span>string <span style=color:#a6e22e>nickname</span>(fstab<span style=color:#f92672>-&gt;</span>recs[i].label);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> flags <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>fs_mgr_is_encryptable</span>(<span style=color:#f92672>&amp;</span>fstab<span style=color:#f92672>-&gt;</span>recs[i])) {
</span></span><span style=display:flex><span>                flags <span style=color:#f92672>|=</span> android<span style=color:#f92672>::</span>vold<span style=color:#f92672>::</span>Disk<span style=color:#f92672>::</span>Flags<span style=color:#f92672>::</span>kAdoptable;
</span></span><span style=display:flex><span>                has_adoptable <span style=color:#f92672>=</span> true;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>fs_mgr_is_noemulatedsd</span>(<span style=color:#f92672>&amp;</span>fstab<span style=color:#f92672>-&gt;</span>recs[i])
</span></span><span style=display:flex><span>                    <span style=color:#f92672>||</span> <span style=color:#a6e22e>property_get_bool</span>(<span style=color:#e6db74>&#34;vold.debug.default_primary&#34;</span>, false)) {
</span></span><span style=display:flex><span>                flags <span style=color:#f92672>|=</span> android<span style=color:#f92672>::</span>vold<span style=color:#f92672>::</span>Disk<span style=color:#f92672>::</span>Flags<span style=color:#f92672>::</span>kDefaultPrimary;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            vm<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>addDiskSource</span>(std<span style=color:#f92672>::</span>shared_ptr<span style=color:#f92672>&lt;</span>VolumeManager<span style=color:#f92672>::</span>DiskSource<span style=color:#f92672>&gt;</span>(
</span></span><span style=display:flex><span>                    new VolumeManager<span style=color:#f92672>::</span><span style=color:#a6e22e>DiskSource</span>(sysPattern, nickname, flags)));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>property_set</span>(<span style=color:#e6db74>&#34;vold.has_adoptable&#34;</span>, has_adoptable <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;1&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;0&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span></code></pre></div><p>fstab is parsed in <a href=http://androidxref.com/7.1.1_r6/xref/system/core/fs_mgr/fs_mgr_fstab.c#mount_flags>fs_mgr_fstab.c</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>struct</span> flag_list mount_flags[] <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    { <span style=color:#e6db74>&#34;noatime&#34;</span>,    MS_NOATIME },
</span></span><span style=display:flex><span>    { <span style=color:#e6db74>&#34;noexec&#34;</span>,     MS_NOEXEC },
</span></span><span style=display:flex><span>    { <span style=color:#e6db74>&#34;nosuid&#34;</span>,     MS_NOSUID },
</span></span><span style=display:flex><span>    { <span style=color:#e6db74>&#34;nodev&#34;</span>,      MS_NODEV },
</span></span><span style=display:flex><span>    { <span style=color:#e6db74>&#34;nodiratime&#34;</span>, MS_NODIRATIME },
</span></span><span style=display:flex><span>    { <span style=color:#e6db74>&#34;ro&#34;</span>,         MS_RDONLY },
</span></span><span style=display:flex><span>    { <span style=color:#e6db74>&#34;rw&#34;</span>,         <span style=color:#ae81ff>0</span> },
</span></span><span style=display:flex><span>    { <span style=color:#e6db74>&#34;remount&#34;</span>,    MS_REMOUNT },
</span></span><span style=display:flex><span>    { <span style=color:#e6db74>&#34;bind&#34;</span>,       MS_BIND },
</span></span><span style=display:flex><span>    { <span style=color:#e6db74>&#34;rec&#34;</span>,        MS_REC },
</span></span><span style=display:flex><span>    { <span style=color:#e6db74>&#34;unbindable&#34;</span>, MS_UNBINDABLE },
</span></span><span style=display:flex><span>    { <span style=color:#e6db74>&#34;private&#34;</span>,    MS_PRIVATE },
</span></span><span style=display:flex><span>    { <span style=color:#e6db74>&#34;slave&#34;</span>,      MS_SLAVE },
</span></span><span style=display:flex><span>    { <span style=color:#e6db74>&#34;shared&#34;</span>,     MS_SHARED },
</span></span><span style=display:flex><span>    { <span style=color:#e6db74>&#34;defaults&#34;</span>,   <span style=color:#ae81ff>0</span> },
</span></span><span style=display:flex><span>    { <span style=color:#ae81ff>0</span>,            <span style=color:#ae81ff>0</span> },
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>struct</span> flag_list fs_mgr_flags[] <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    { <span style=color:#e6db74>&#34;wait&#34;</span>,        MF_WAIT },
</span></span><span style=display:flex><span>    { <span style=color:#e6db74>&#34;check&#34;</span>,       MF_CHECK },
</span></span><span style=display:flex><span>    { <span style=color:#e6db74>&#34;encryptable=&#34;</span>,MF_CRYPT },
</span></span><span style=display:flex><span>    { <span style=color:#e6db74>&#34;forceencrypt=&#34;</span>,MF_FORCECRYPT },
</span></span><span style=display:flex><span>    { <span style=color:#e6db74>&#34;fileencryption=&#34;</span>,MF_FILEENCRYPTION },
</span></span><span style=display:flex><span>    { <span style=color:#e6db74>&#34;forcefdeorfbe=&#34;</span>,MF_FORCEFDEORFBE },
</span></span><span style=display:flex><span>    { <span style=color:#e6db74>&#34;nonremovable&#34;</span>,MF_NONREMOVABLE },
</span></span><span style=display:flex><span>    { <span style=color:#e6db74>&#34;voldmanaged=&#34;</span>,MF_VOLDMANAGED},
</span></span><span style=display:flex><span>    { <span style=color:#e6db74>&#34;length=&#34;</span>,     MF_LENGTH },
</span></span><span style=display:flex><span>    { <span style=color:#e6db74>&#34;recoveryonly&#34;</span>,MF_RECOVERYONLY },
</span></span><span style=display:flex><span>    { <span style=color:#e6db74>&#34;swapprio=&#34;</span>,   MF_SWAPPRIO },
</span></span><span style=display:flex><span>    { <span style=color:#e6db74>&#34;zramsize=&#34;</span>,   MF_ZRAMSIZE },
</span></span><span style=display:flex><span>    { <span style=color:#e6db74>&#34;verify&#34;</span>,      MF_VERIFY },
</span></span><span style=display:flex><span>    { <span style=color:#e6db74>&#34;noemulatedsd&#34;</span>, MF_NOEMULATEDSD },
</span></span><span style=display:flex><span>    { <span style=color:#e6db74>&#34;notrim&#34;</span>,       MF_NOTRIM },
</span></span><span style=display:flex><span>    { <span style=color:#e6db74>&#34;formattable&#34;</span>, MF_FORMATTABLE },
</span></span><span style=display:flex><span>    { <span style=color:#e6db74>&#34;slotselect&#34;</span>,  MF_SLOTSELECT },
</span></span><span style=display:flex><span>    { <span style=color:#e6db74>&#34;nofail&#34;</span>,      MF_NOFAIL },
</span></span><span style=display:flex><span>    { <span style=color:#e6db74>&#34;latemount&#34;</span>,   MF_LATEMOUNT },
</span></span><span style=display:flex><span>    { <span style=color:#e6db74>&#34;defaults&#34;</span>,    <span style=color:#ae81ff>0</span> },
</span></span><span style=display:flex><span>    { <span style=color:#ae81ff>0</span>,             <span style=color:#ae81ff>0</span> },
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><h2 id=creating-private-partition>Creating Private Partition<a hidden class=anchor aria-hidden=true href=#creating-private-partition>#</a></h2><p>Tracing the code flow via <code>sm partition DISK private</code> command.<br><a href=http://androidxref.com/7.1.1_r6/xref/frameworks/base/cmds/sm/src/com/android/commands/sm/Sm.java#runPartition>frameworks/base/cmds/sm/src/com/android/commands/sm/Sm.java</a></p><pre tabindex=0><code>public void runPartition() throws RemoteException {
    final String diskId = nextArg();
    final String type = nextArg();
    if (&#34;public&#34;.equals(type)) {
	mSm.partitionPublic(diskId);
    } else if (&#34;private&#34;.equals(type)) {
	mSm.partitionPrivate(diskId);
    } else if (&#34;mixed&#34;.equals(type)) {
	final int ratio = Integer.parseInt(nextArg());
	mSm.partitionMixed(diskId, ratio);
    } else {
	throw new IllegalArgumentException(&#34;Unsupported partition type &#34; + type);
    }
}
</code></pre><p>then VoldConnector issues partition command to Vold.<br><a href=http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/com/android/server/MountService.java#partitionPrivate>MountService::partitionPrivate</a></p><pre tabindex=0><code>mConnector.execute(&#34;volume&#34;, &#34;partition&#34;, diskId, &#34;private&#34;); 
</code></pre><p><a href=http://androidxref.com/7.1.1_r6/xref/system/vold/CommandListener.cpp#141>CommandListener::VolumeCmd::runCommand</a></p><pre tabindex=0><code>return sendGenericOkFail(cli, disk-&gt;partitionPrivate());
</code></pre><p>Vold handles the partition request.<br><a href=http://androidxref.com/7.1.1_r6/xref/system/vold/Disk.cpp#partitionMixed>Disk::partitionMixed</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e># Force unmount all volumes  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>destroyAllVolumes</span>(); 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Destory the GPT data structures and then exit.
</span></span></span><span style=display:flex><span><span style=color:#75715e># /system/bin/sgdisk
</span></span></span><span style=display:flex><span><span style=color:#75715e>#     --zap-all 
</span></span></span><span style=display:flex><span><span style=color:#75715e>#     /dev/block/vold/disk:8,0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// Zap sometimes returns an error when it actually succeeded, so
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// just log as warning and keep rolling forward.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> ((res <span style=color:#f92672>=</span> <span style=color:#a6e22e>ForkExecvp</span>(cmd)) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>LOG</span>(WARNING) <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;Failed to zap; status &#34;</span> <span style=color:#f92672>&lt;&lt;</span> res;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Create encrypt key and parition GUID for android_expand. 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>ReadRandomBytes</span>(<span style=color:#ae81ff>16</span>, partGuidRaw) <span style=color:#f92672>||</span> <span style=color:#a6e22e>ReadRandomBytes</span>(<span style=color:#ae81ff>16</span>, keyRaw)) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>LOG</span>(ERROR) <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;Failed to generate GUID or key&#34;</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span>EIO;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Write key to /data/misc/vold/expand_GUID.key   
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>WriteStringToFile</span>(keyRaw, <span style=color:#a6e22e>BuildKeyPath</span>(partGuid))) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>LOG</span>(ERROR) <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;Failed to persist key&#34;</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span>EIO;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>LOG</span>(DEBUG) <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;Persisted key for GUID &#34;</span> <span style=color:#f92672>&lt;&lt;</span> partGuid;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Run partition command via sgdisk tool 
</span></span></span><span style=display:flex><span><span style=color:#75715e># /system/bin/sgdisk
</span></span></span><span style=display:flex><span><span style=color:#75715e>#     --new=0:0:+16M
</span></span></span><span style=display:flex><span><span style=color:#75715e>#     --typecode=0:19A710A2-B3CA-11E4-B026-10604B889DCF
</span></span></span><span style=display:flex><span><span style=color:#75715e>#     --change-name=0:android_meta
</span></span></span><span style=display:flex><span><span style=color:#75715e>#     --new=0:0:-0
</span></span></span><span style=display:flex><span><span style=color:#75715e>#     --typecode=0:193D1EA4-B3CA-11E4-B075-10604B889DCF
</span></span></span><span style=display:flex><span><span style=color:#75715e>#     --partition-guid=0:c245733cd8ed24d20047ba0c3213de60
</span></span></span><span style=display:flex><span><span style=color:#75715e>#     --change-name=0:android_expand
</span></span></span><span style=display:flex><span><span style=color:#75715e>#     /dev/block/vold/disk:8,0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> ((res <span style=color:#f92672>=</span> <span style=color:#a6e22e>ForkExecvp</span>(cmd)) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>LOG</span>(ERROR) <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;Failed to partition; status &#34;</span> <span style=color:#f92672>&lt;&lt;</span> res;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> res;
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><h2 id=mounting-private-partition>Mounting Private Partition<a hidden class=anchor aria-hidden=true href=#mounting-private-partition>#</a></h2><p>After disk&rsquo;s partition is changed, kernel rescans the disk and emits an uevent to notify Vold.<br><a href=http://androidxref.com/7.1.1_r6/xref/system/vold/VolumeManager.cpp#handleBlockEvent>VolumeManager::handleBlockEvent</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>    <span style=color:#66d9ef>case</span> NetlinkEvent<span style=color:#f92672>::</span>Action<span style=color:#f92672>::</span>kAdd: {
</span></span><span style=display:flex><span>		...
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>auto</span> disk <span style=color:#f92672>=</span> new android<span style=color:#f92672>::</span>vold<span style=color:#f92672>::</span><span style=color:#a6e22e>Disk</span>(eventPath, device,
</span></span><span style=display:flex><span>                        source<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>getNickname</span>(), flags);
</span></span><span style=display:flex><span>                disk<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>create</span>();
</span></span><span style=display:flex><span>                mDisks.<span style=color:#a6e22e>push_back</span>(std<span style=color:#f92672>::</span>shared_ptr<span style=color:#f92672>&lt;</span>android<span style=color:#f92672>::</span>vold<span style=color:#f92672>::</span>Disk<span style=color:#f92672>&gt;</span>(disk));
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p><a href=http://androidxref.com/7.1.1_r6/xref/system/vold/Disk.cpp#create>Disk::create</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>notifyEvent</span>(ResponseCode<span style=color:#f92672>::</span>DiskCreated, <span style=color:#a6e22e>StringPrintf</span>(<span style=color:#e6db74>&#34;%d&#34;</span>, mFlags));
</span></span><span style=display:flex><span><span style=color:#75715e># Read lable, size, and system path 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>readMetadata</span>();
</span></span><span style=display:flex><span><span style=color:#75715e># parsing partition table 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>readPartitions</span>();
</span></span></code></pre></div><p><a href=http://androidxref.com/7.1.1_r6/xref/system/vold/Disk.cpp#readPartitions>Disk::readPartitions</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e># Force unmount all volumes  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>destroyAllVolumes</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Parsing partition table 
</span></span></span><span style=display:flex><span><span style=color:#75715e># /system/bin/sgdisk
</span></span></span><span style=display:flex><span><span style=color:#75715e>#     --android-dump
</span></span></span><span style=display:flex><span><span style=color:#75715e>#     /dev/block/vold/disk:8,0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>status_t</span> res <span style=color:#f92672>=</span> <span style=color:#a6e22e>ForkExecvp</span>(cmd, output);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Encrypted storage is used GPT partition table only. 
</span></span></span><span style=display:flex><span><span style=color:#75715e># Starting to create private volume   
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (table <span style=color:#f92672>==</span> Table<span style=color:#f92672>::</span>kGpt) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> typeGuid <span style=color:#f92672>=</span> <span style=color:#a6e22e>strtok</span>(nullptr, kSgdiskToken);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> partGuid <span style=color:#f92672>=</span> <span style=color:#a6e22e>strtok</span>(nullptr, kSgdiskToken);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>strcasecmp</span>(typeGuid, kGptBasicData)) {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>createPublicVolume</span>(partDevice);
</span></span><span style=display:flex><span>                } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>strcasecmp</span>(typeGuid, kGptAndroidExpand)) {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>createPrivateVolume</span>(partDevice, partGuid);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span><span style=color:#75715e># Notify MountService  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>notifyEvent</span>(ResponseCode<span style=color:#f92672>::</span>DiskScanned); 
</span></span></code></pre></div><p>Creating private volume
<a href=http://androidxref.com/7.1.1_r6/xref/system/vold/Disk.cpp#createPrivateVolume>Disk::createPrivateVolume</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e># Verify GUID and encrypt key
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>NormalizeHex</span>(partGuid, normalizedGuid)) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>LOG</span>(WARNING) <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;Invalid GUID &#34;</span> <span style=color:#f92672>&lt;&lt;</span> partGuid;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    std<span style=color:#f92672>::</span>string keyRaw;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>ReadFileToString</span>(<span style=color:#a6e22e>BuildKeyPath</span>(normalizedGuid), <span style=color:#f92672>&amp;</span>keyRaw)) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>PLOG</span>(ERROR) <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;Failed to load key for GUID &#34;</span> <span style=color:#f92672>&lt;&lt;</span> normalizedGuid;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Create private volume and format then destroy it.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>auto</span> vol <span style=color:#f92672>=</span> std<span style=color:#f92672>::</span>shared_ptr<span style=color:#f92672>&lt;</span>VolumeBase<span style=color:#f92672>&gt;</span>(new <span style=color:#a6e22e>PrivateVolume</span>(device, keyRaw));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (mJustPartitioned) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>LOG</span>(DEBUG) <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;Device just partitioned; silently formatting&#34;</span>;
</span></span><span style=display:flex><span>        vol<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>setSilent</span>(true);
</span></span><span style=display:flex><span>        vol<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>create</span>();
</span></span><span style=display:flex><span>        vol<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>format</span>(<span style=color:#e6db74>&#34;auto&#34;</span>);
</span></span><span style=display:flex><span>        vol<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>destroy</span>();
</span></span><span style=display:flex><span>        vol<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>setSilent</span>(false);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># volume create again  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    mVolumes.<span style=color:#a6e22e>push_back</span>(vol);
</span></span><span style=display:flex><span>    vol<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>setDiskId</span>(<span style=color:#a6e22e>getId</span>());
</span></span><span style=display:flex><span>    vol<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>setPartGuid</span>(partGuid);
</span></span><span style=display:flex><span>    vol<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>create</span>();
</span></span></code></pre></div><p><a href=http://androidxref.com/7.1.1_r6/xref/system/vold/VolumeBase.cpp#create>VolumeBase::create</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e># PrivateVolume::doCreate  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>status_t</span> res <span style=color:#f92672>=</span> <span style=color:#a6e22e>doCreate</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Notify MountService to mount volume use onVolumeCreatedLocked()  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>notifyEvent</span>(ResponseCode<span style=color:#f92672>::</span>VolumeCreated,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>StringPrintf</span>(<span style=color:#e6db74>&#34;%d </span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>%s</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74> </span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>%s</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>&#34;</span>, mType, mDiskId.<span style=color:#a6e22e>c_str</span>(), mPartGuid.<span style=color:#a6e22e>c_str</span>()));
</span></span></code></pre></div><p><a href=http://androidxref.com/7.1.1_r6/xref/system/vold/PrivateVolume.cpp#doCreate>PrivateVolume::doCreate</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>CreateDeviceNode</span>(mRawDevPath, mRawDevice)) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span>EIO;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Recover from stale vold by tearing down any old mappings
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>cryptfs_revert_ext_volume</span>(<span style=color:#a6e22e>getId</span>().<span style=color:#a6e22e>c_str</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// TODO: figure out better SELinux labels for private volumes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> key <span style=color:#f92672>=</span> (<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span>) mKeyRaw.<span style=color:#a6e22e>data</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> crypto_blkdev[MAXPATHLEN];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> res <span style=color:#f92672>=</span> <span style=color:#a6e22e>cryptfs_setup_ext_volume</span>(<span style=color:#a6e22e>getId</span>().<span style=color:#a6e22e>c_str</span>(), mRawDevPath.<span style=color:#a6e22e>c_str</span>(),
</span></span><span style=display:flex><span>            key, mKeyRaw.<span style=color:#a6e22e>size</span>(), crypto_blkdev);
</span></span><span style=display:flex><span>    mDmDevPath <span style=color:#f92672>=</span> crypto_blkdev;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (res <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>PLOG</span>(ERROR) <span style=color:#f92672>&lt;&lt;</span> <span style=color:#a6e22e>getId</span>() <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34; failed to setup cryptfs&#34;</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span>EIO;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> OK;
</span></span></code></pre></div><p>When MountService receives VOLUME_CREATED event from VolumeBase::create(), it calls Vold to do mount process.</p><p><a href=http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/com/android/server/MountService.java#onEventLocked>MountService::onEventLocked</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span> Handle event from VolumeBase<span style=color:#f92672>::</span>create then get disk info<span style=color:#f92672>.</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> VoldResponseCode<span style=color:#f92672>.</span><span style=color:#a6e22e>VOLUME_CREATED</span><span style=color:#f92672>:</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>final</span> String id <span style=color:#f92672>=</span> cooked<span style=color:#f92672>[</span><span style=color:#ae81ff>1</span><span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> type <span style=color:#f92672>=</span> Integer<span style=color:#f92672>.</span><span style=color:#a6e22e>parseInt</span><span style=color:#f92672>(</span>cooked<span style=color:#f92672>[</span><span style=color:#ae81ff>2</span><span style=color:#f92672>]);</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>final</span> String diskId <span style=color:#f92672>=</span> TextUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>nullIfEmpty</span><span style=color:#f92672>(</span>cooked<span style=color:#f92672>[</span><span style=color:#ae81ff>3</span><span style=color:#f92672>]);</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>final</span> String partGuid <span style=color:#f92672>=</span> TextUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>nullIfEmpty</span><span style=color:#f92672>(</span>cooked<span style=color:#f92672>[</span><span style=color:#ae81ff>4</span><span style=color:#f92672>]);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>final</span> DiskInfo disk <span style=color:#f92672>=</span> mDisks<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>diskId<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>final</span> VolumeInfo vol <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> VolumeInfo<span style=color:#f92672>(</span>id<span style=color:#f92672>,</span> type<span style=color:#f92672>,</span> disk<span style=color:#f92672>,</span> partGuid<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>	mVolumes<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>id<span style=color:#f92672>,</span> vol<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span> Ack Vold to mount <span style=color:#66d9ef>this</span> volume<span style=color:#f92672>.</span> 
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>onVolumeCreatedLocked</span><span style=color:#f92672>(</span>vol<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><p><a href=http://androidxref.com/7.1.1_r6/xref/frameworks/base/services/core/java/com/android/server/MountService.java#handleMessage>MountService::handleMessage</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span> Ack Vold to run mount command via vold<span style=color:#f92672>/</span>CommandListener<span style=color:#f92672>.</span>   
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> H_VOLUME_MOUNT<span style=color:#f92672>:</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>final</span> VolumeInfo vol <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>VolumeInfo<span style=color:#f92672>)</span> msg<span style=color:#f92672>.</span><span style=color:#a6e22e>obj</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isMountDisallowed<span style=color:#f92672>(</span>vol<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	    Slog<span style=color:#f92672>.</span><span style=color:#a6e22e>i</span><span style=color:#f92672>(</span>TAG<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Ignoring mount &#34;</span> <span style=color:#f92672>+</span> vol<span style=color:#f92672>.</span><span style=color:#a6e22e>getId</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; due to policy&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>	    <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	    mConnector<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;volume&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;mount&#34;</span><span style=color:#f92672>,</span> vol<span style=color:#f92672>.</span><span style=color:#a6e22e>id</span><span style=color:#f92672>,</span> vol<span style=color:#f92672>.</span><span style=color:#a6e22e>mountFlags</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>		    vol<span style=color:#f92672>.</span><span style=color:#a6e22e>mountUserId</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>NativeDaemonConnectorException ignored<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><p><a href=http://androidxref.com/7.1.1_r6/xref/system/vold/CommandListener.cpp#208>CommandListener::VolumeCmd::runCommand</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (cmd <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;mount&#34;</span> <span style=color:#f92672>&amp;&amp;</span> argc <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>2</span>) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// mount [volId] [flags] [user]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        std<span style=color:#f92672>::</span>string <span style=color:#a6e22e>id</span>(argv[<span style=color:#ae81ff>2</span>]);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>auto</span> vol <span style=color:#f92672>=</span> vm<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>findVolume</span>(id);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (vol <span style=color:#f92672>==</span> nullptr) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> cli<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>sendMsg</span>(ResponseCode<span style=color:#f92672>::</span>CommandSyntaxError, <span style=color:#e6db74>&#34;Unknown volume&#34;</span>, false);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> mountFlags <span style=color:#f92672>=</span> (argc <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>3</span>) <span style=color:#f92672>?</span> <span style=color:#a6e22e>atoi</span>(argv[<span style=color:#ae81ff>3</span>]) <span style=color:#f92672>:</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>userid_t</span> mountUserId <span style=color:#f92672>=</span> (argc <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>4</span>) <span style=color:#f92672>?</span> <span style=color:#a6e22e>atoi</span>(argv[<span style=color:#ae81ff>4</span>]) <span style=color:#f92672>:</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        vol<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>setMountFlags</span>(mountFlags);
</span></span><span style=display:flex><span>        vol<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>setMountUserId</span>(mountUserId);
</span></span><span style=display:flex><span><span style=color:#75715e># Call VolumeBase::mount() then PrivateVolume::doMount() 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>int</span> res <span style=color:#f92672>=</span> vol<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>mount</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (mountFlags <span style=color:#f92672>&amp;</span> android<span style=color:#f92672>::</span>vold<span style=color:#f92672>::</span>VolumeBase<span style=color:#f92672>::</span>MountFlags<span style=color:#f92672>::</span>kPrimary) {
</span></span><span style=display:flex><span>            vm<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>setPrimary</span>(vol);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>sendGenericOkFail</span>(cli, res);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (cmd <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;unmount&#34;</span> <span style=color:#f92672>&amp;&amp;</span> argc <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>2</span>) {
</span></span></code></pre></div><h1 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h1><p>The prosess of adoptable storage is more simple than <a href=/blog/2016/04/29/android-full-disk-encryption-workflow>Full Disk Encryption</a></p><ol><li>Unmount all volumes.</li><li>Create new GPT table, GUID, and encrypt key.</li><li>Generate android_meta, android_expand, and shared (if ratio partition) partitions.</li><li>Get block device added uevent from Kernel.</li><li>Decrypt private volumes.</li><li>Mount public and private volumes.</li></ol><h1 id=related-source-code>Related Source code<a hidden class=anchor aria-hidden=true href=#related-source-code>#</a></h1><pre tabindex=0><code># Communicate with Vold and Framework. 
frameworks/base/services/core/java/com/android/server/MountService.java

# Parse fstab. 
system/core/fs_mgr  

# Partition, mount, unmout, and format private volume
# Genrate encrypt key. 
system/vold/

# Decrytp and encrypt private volume, crypto type name is &#34;aes-cbc-essiv:sha256&#34; 
system/vold/cryptfs.c

# Partition tool 
external/gptfdisk/sgdisk.cc
</code></pre></div><footer class=post-footer><ul class=post-tags><li><a href=https://oopsmonk.github.io/tags/android/>Android</a></li></ul><nav class=paginav><a class=prev href=https://oopsmonk.github.io/posts/2017-02-28-2017month2/><span class=title>« Prev</span><br><span>新章</span></a>
<a class=next href=https://oopsmonk.github.io/posts/2016-06-16-android-media-framework/><span class=title>Next »</span><br><span>Android Media Framework</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Android Adoptable Storage on twitter" href="https://twitter.com/intent/tweet/?text=Android%20Adoptable%20Storage&amp;url=https%3a%2f%2foopsmonk.github.io%2fposts%2f2017-02-13-android-adoptable-storage%2f&amp;hashtags=Android"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Android Adoptable Storage on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2foopsmonk.github.io%2fposts%2f2017-02-13-android-adoptable-storage%2f&amp;title=Android%20Adoptable%20Storage&amp;summary=Android%20Adoptable%20Storage&amp;source=https%3a%2f%2foopsmonk.github.io%2fposts%2f2017-02-13-android-adoptable-storage%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Android Adoptable Storage on reddit" href="https://reddit.com/submit?url=https%3a%2f%2foopsmonk.github.io%2fposts%2f2017-02-13-android-adoptable-storage%2f&title=Android%20Adoptable%20Storage"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Android Adoptable Storage on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2foopsmonk.github.io%2fposts%2f2017-02-13-android-adoptable-storage%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Android Adoptable Storage on whatsapp" href="https://api.whatsapp.com/send?text=Android%20Adoptable%20Storage%20-%20https%3a%2f%2foopsmonk.github.io%2fposts%2f2017-02-13-android-adoptable-storage%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Android Adoptable Storage on telegram" href="https://telegram.me/share/url?text=Android%20Adoptable%20Storage&amp;url=https%3a%2f%2foopsmonk.github.io%2fposts%2f2017-02-13-android-adoptable-storage%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://oopsmonk.github.io/>oopsmonk</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>